---
layout: post
title: Haproxy URL Rewrite Logging Double Take
date: 2015-05-28 22:45:32.000000000 -06:00
type: post
published: true
status: publish
categories: []
tags:
- haproxy
meta:
  _wpcom_is_markdown: '1'
  _edit_last: '19750133'
  geo_public: '0'
  publicize_google_plus_url: https://plus.google.com/+JohnTSkarbek/posts/TFMEbNcATLA
  _publicize_job_id: '11118156705'
  publicize_linkedin_url: https://www.linkedin.com/updates?discuss=&scope=35280723&stype=M&topic=6009897140971720704&type=U&a=TsfH
  _publicize_done_1977106: '1'
  _wpas_done_1386473: '1'
  _publicize_done_5894639: '1'
  _wpas_done_5858344: '1'
author:
  login: jskarbek
  email: jtslear@gmail.com
  display_name: jskarbek
  first_name: ''
  last_name: ''
---
<p>Haproxy threw me for a loop today. It wasn't until I did a packet capture that<br />
I discovered I was doing something correctly.</p>
<p>When doing URL rewrites, haproxy doesn't log the final outcome of a GET request<br />
to its logs. So while during testing something wasn't working correctly, and<br />
the client was sending the request properly, I was confused as I initially<br />
expected the rewritten GET request to be logged when in fact it is not. Here's<br />
my example haproxy configuration:</p>
<p>[code lang=text]<br />
backend success_backend<br />
reqirep ^([^\ :]*)\ (/[^/]+/[^/]+)(.*) \1\ /replaced\3<br />
server localhost 127.0.0.1:4567<br />
[/code]</p>
<p>Here's my curl:</p>
<p>[code lang=text]<br />
[root ~]# curl http://localhost/something1/something2/get<br />
reached via replaced/get<br />
[root ~]#<br />
[/code]</p>
<p>The response received is what I expected.</p>
<p>Here&#039;s what we see in the logs:</p>
<p>[code lang=text]<br />
May 28 21:16:33 default-centos-66-x86-64 haproxy[22376]: 127.0.0.1:9856<br />
[28/May/2015:21:16:33.831] tester14 success_backend/localhost 0/0/0/4/4 200 306<br />
- - ---- 1/1/0/1/0 0/0 &quot;GET /something1/something2/get HTTP/1.1&quot;<br />
[/code]</p>
<p>Here&#039;s what show up during a packet capture:</p>
<p>[code lang=text]<br />
21:16:33.831962 IP 127.0.0.1.9856 &gt; 127.0.0.1.80: Flags [P.], seq<br />
3445881728:3445881927, ack 2505859966, win 1024, options [nop,nop,TS val 3145623<br />
ecr 3145623], length 199<br />
E.....@.@.7.........&amp;..P.c...\c~...........<br />
./.../..GET /something1/something2/get HTTP/1.1<br />
User-Agent: Mozilla/2.0 (compatible; MSIE 3.0; Windows 3.1)<br />
Host: localhost<br />
Accept: */*</p>
<p>21:16:33.832107 IP 127.0.0.1.42314 &gt; 127.0.0.1.4567: Flags [P.], seq<br />
3175948661:3175948869, ack 1519403319, win 1024, options [nop,nop,TS val 3145624<br />
ecr 3145624], length 208<br />
E.....@.@.]..........J...M!uZ.A7...........<br />
./.../..GET /replaced/get HTTP/1.1<br />
User-Agent: Mozilla/2.0 (compatible; MSIE 3.0; Windows 3.1)<br />
Host: localhost<br />
Accept: */*<br />
client-ip: 127.0.0.1<br />
[/code]</p>
<p>That first packet is the curl going to haproxy, the second packet is haproxy<br />
reaching out to the tiny tester app. Haproxy did exactly what was intended.</p>
<h2>Resources:</h2>
<ul>
<li><a href="https://gist.github.com/jtslear/055486fd91d82372dee8">tiny tester app</a></li>
<li><a href="https://github.com/jtslear/dotfiles/blob/master/curlrc">curlrc file</a></li>
</ul>

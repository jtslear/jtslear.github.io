---
layout: post
title: Haproxy Quick ACL Testing
date: 2015-05-28 21:47:30.000000000 -06:00
type: post
published: true
status: publish
categories: []
tags:
- haproxy
meta:
  _oembed_a687697cd25e182ca48ac42a8e29eb04: "{{unknown}}"
  publicize_google_plus_url: https://plus.google.com/+JohnTSkarbek/posts/cGyLnibv1ig
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '11117244115'
  publicize_linkedin_url: https://www.linkedin.com/updates?discuss=&scope=35280723&stype=M&topic=6009882542658899968&type=U&a=Sg6x
  _publicize_done_1977106: '1'
  _wpas_done_1386473: '1'
  _publicize_done_5894639: '1'
  _wpas_done_5858344: '1'
  _oembed_d552750baa1ef6d234a82432e09bc49b: "{{unknown}}"
  _wpcom_is_markdown: '1'
  _post_restored_from: a:3:{s:20:"restored_revision_id";i:232;s:16:"restored_by_user";i:19750133;s:13:"restored_time";i:1432868201;}
  _edit_last: '19750133'
  _oembed_2387cabd10aa6820f70d43b4d06de232: "{{unknown}}"
  _oembed_1edcea3743bdb48bd03e891d462334fc: "{{unknown}}"
  geo_public: '0'
  _wpas_skip_5858344: '1'
  _wpas_skip_1386473: '1'
author:
  login: jskarbek
  email: jtslear@gmail.com
  display_name: jskarbek
  first_name: ''
  last_name: ''
---
<p>This is just a very minor setup that I'm using that I thought I'd share for<br />
testing acl rules and such.</p>
<p>Ruby sinatra is a great and very quick way to spin up a tiny webservice. By<br />
default it'll run webrick which is fine for this method of testing.  Here's what<br />
my app looks like:</p>
<p>[code lang=ruby]<br />
require &#039;sinatra&#039;<br />
set :port, ARGV[1]<br />
get &#039;*&#039; do<br />
  &quot;#{ARGV[0]}&quot;<br />
end<br />
[/code]</p>
<p>And then I have this spun up via a very tiny barely functional init script (we<br />
use chef, I didn't feel like spinning up a ruby environment, so I hacked into<br />
chef's embedded ruby):</p>
<p>[code lang=shell]<br />
#!/bin/bash<br />
/opt/chef/embedded/bin/ruby /root/test-web-app.rb success 4567 &gt;&gt; /dev/null 2&gt;&amp;1 &amp;<br />
/opt/chef/embedded/bin/ruby /root/test-web-app.rb fail 4568 &gt;&gt; /dev/null 2&gt;&amp;1 &amp;<br />
RETVAL=$?<br />
exit $RETVAL<br />
[/code]</p>
<p>And then when I need to test a rule in haproxy I set it up like so:</p>
<p>[code lang=text]<br />
backend success_backend<br />
  server localhost 127.0.0.1:4567 check<br />
backend fail_backend<br />
  server localhost 127.0.0.1:4568 check<br />
[/code]</p>
<p>Then in my frontend I can create acl's and send them to either backend for quick<br />
testing.</p>
<p>[code lang=text]<br />
acl successful url_beg /yay<br />
use_backend success_backend if successful<br />
default_backend fail_backend if failure<br />
[/code]</p>
<p>And then doing a test using curl we see that this worked well enough.</p>
<p>[code lang=text]<br />
[root~]# curl http://localhost/yay<br />
success<br />
[root~]# curl http://localhost/aww<br />
fail<br />
[root~]#<br />
[/code]</p>
<p>This becomes limiting when you need to start messing with things like redirects<br />
or if you need to pay attention to headers and cookies.  But for starting off,<br />
especially learning and getting the hang of haproxy, this was very ideal.<br />
Sinatra makes this incredibly easy for helping me test rewrites.</p>
<h2>Resources:</h2>
<ul>
<li><a href="http://www.sinatrarb.com/">sinatrarb</a></li>
<li><a href="http://www.haproxy.org/">haproxy</a></li>
<li><a href="https://gist.github.com/jtslear/c731c1a591c73d9ad339">my deploy recipe</a></li>
</ul>
